{% extends 'decisions/base.html' %}
{% load bootstrap %}
{% load module_tags %}
{% block title %}{% block h1 %}Module {{ module.display_num }} - The Bias Game{% endblock %}{% endblock %}
{% block content %}
    <style type="text/css">
        button {
            height: inherit !important;
            text-transform: none !important;
            line-height: 120%;
            width: 100%;
        }
    </style>
    <script type="text/javascript">
        var questions = {
            {% for question in questions %}
                '{{ forloop.counter }}': {
                    'title': "{{ question.title }}",
                    'question': "{{ question.question|safe }}",
                    'answer0': "{{ question.answer0|safe }}",
                    'answer1': "{{ question.answer1|safe }}",
                    'bias_answer': "{{ question.bias_answer|safe }}",
                    'explanation0': "{{ question.explanation0|safe }}",
                    'explanation1': "{{ question.explanation1|safe }}",
                    'definition': "{{ question.definition|safe }}",
                },
            {% endfor %}
        }

        function answer(val) {
            var question_ndx = $('#question_index').text();
            // What should the answer be?
            var expected = questions[question_ndx]['bias_answer'];

            if (expected == val) {
                // Increment our total correct
                total_correct++;
                updateCounter();
            } else {
                // Show the error messsage
                var explanation = questions[question_ndx]['explanation' + val];
                alert(explanation);
            }

            // Store the answer regardless of whether it was right or wrong
            $('#answer_' + question_ndx).val(val);

            // Show the next question
            question_num++;
            return next_question();
        }

        function updateCounter() {
            $('#total_correct').text(total_correct);
        }

        var question_num = 0;
        var num_questions = {{ num_questions }};
        var animation_direction = 'left';
        var total_correct = 0;

        function shuffle(a) {
            var j, x, i;
            for (i = a.length; i; i--) {
                j = Math.floor(Math.random() * i);
                x = a[i - 1];
                a[i - 1] = a[j];
                a[j] = x;
            }
            return a;
        }

        var random_order = [];
        for (i = 1; i <= num_questions; i++) {
            random_order.push(i);
        }
        shuffle(random_order);

        function next_question() {
            $('#game').css('position', 'absolute');
            console.log("question_num: " + question_num + " num_questions:" + num_questions);

            if (question_num >= num_questions) {
                console.log("Done with all questions. Form submit");
                $('form:last').submit();
                return true;
                //return false;
            }

            if (animation_direction == 'right') {
                animation_direction = 'left';
            } else {
                animation_direction = 'right';
            }
            var question_index = random_order[question_num];
            $('#question_index').text(question_index);
            $('#question').text(questions[question_index]['question']);
            $('#answer0').text(questions[question_index]['answer0']);
            $('#answer1').text(questions[question_index]['answer1']);
            $('#definition').text(questions[question_index]['definition']);

            if (animation_direction == 'right') {
                $('#game').css('left', '60%');
                $('#game').animate({'left': '30%'}, function () {
                    $('#game').css('position', 'inherit');
                });
            } else {
                $('#game').css('left', '0%');
                $('#game').animate({'left': '30%'}, function () {
                    $('#game').css('position', 'inherit');
                });
            }
            return false;
        }

        $(document).ready(function () {
            console.log("Calling doc ready");
            $('#game').width($('h2').width());

            // Initialize
            $('#total_correct').text(0);
            $('#total_questions').text(num_questions);

            next_question();
        });
    </script>

    <h2 class="center">The Bias Game</h2>

    <div style="float: right; font-size: 1.5em;"><strong>Correct: </strong> <span id="total_correct"></span> / <span
            id="total_questions"></span></div>

    <div class="space" style="padding-top: 1px;"></div>
    <div>
        <div id="game" style="position: absolute; font-size: 18px; text-align: center; overflow: visible">
            <div id="question_wrapper">
                <div id="definition" style="text-align: left"></div>
                <div id="question" style="text-align: left; padding-top: 20px;"></div>
                <span id="question_index" style="display: none"></span>
                <div id="answers" style="margin-left: 5%; margin-top: 20px;">
                    <button onclick="$(this).blur(); return answer('0');" id="answer0"></button>
                    <div>&nbsp;</div>
                    <button onclick="$(this).blur(); return answer('1');" id="answer1"></button>
                </div>
            </div>
        </div>
    </div>

    {% for question in questions %}
        <input type="hidden" name="answer[{{ forloop.counter0 }}]" id="answer_{{ forloop.counter }}" value=""/>
    {% endfor %}

    {% get_back_link module nav.previousUrl %}
{% endblock %}
